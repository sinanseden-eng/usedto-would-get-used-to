import React, { useState } from 'react';
import { History, Mic, Volume2, Check, X, Info, RefreshCw, Brain, MessageSquare, AlertTriangle, ArrowRight, Edit3, RotateCcw, Star, Gamepad2 } from 'lucide-react';

const StudyPage = () => {
  const [activeTab, setActiveTab] = useState('reading');
  const [speechSpeaking, setSpeechSpeaking] = useState(false);

  // Reading Content
  const storyTitle = "The Tlingit Storytellers";
  const storyText = `
    "When I was a child," says Clea Kalz, "my grandma used to tell me traditional stories, about Raven and how he brought light to our world."
    
    Clea is a member of the Tlingit tribe in North Alaska, and the oral stories her grandma told her preserve their culture and beliefs. Her grandmother remembered them because the Tlingit people had been telling the same stories for hundreds of years.
    
    Storytelling predates writing. In early societies, people would tell stories orally, passing on information from one generation to the next. There used to be stories to remember historical events, and there were stories that taught important life lessons, too.
    
    Today we are used to reading written accounts of past events. It would be hard to get used to memorizing stories again.
  `;

  // Text to Speech Functionality
  const handleSpeak = () => {
    if ('speechSynthesis' in window) {
      if (speechSpeaking) {
        window.speechSynthesis.cancel();
        setSpeechSpeaking(false);
      } else {
        const utterance = new SpeechSynthesisUtterance(storyText);
        utterance.rate = 0.9; 
        utterance.pitch = 1;
        utterance.onend = () => setSpeechSpeaking(false);
        window.speechSynthesis.speak(utterance);
        setSpeechSpeaking(true);
      }
    } else {
      alert("Sorry, your browser doesn't support text-to-speech.");
    }
  };

  return (
    <div className="min-h-screen bg-stone-50 font-sans text-stone-800 pb-12">
      {/* Navigation Header */}
      <nav className="bg-teal-900 text-white p-4 shadow-lg sticky top-0 z-50">
        <div className="max-w-5xl mx-auto flex flex-col sm:flex-row justify-between items-center">
          <div className="flex items-center space-x-2 mb-4 sm:mb-0">
            <Brain className="w-8 h-8 text-teal-300" />
            <h1 className="text-xl font-bold tracking-wider">LINGUO<span className="text-teal-300">LAB</span> | Unit 8</h1>
          </div>
          <div className="flex space-x-2 bg-teal-800 rounded-lg p-1 overflow-x-auto max-w-full">
            {['reading', 'grammar', 'practice', 'rewrite'].map((tab) => (
              <button
                key={tab}
                onClick={() => setActiveTab(tab)}
                className={`px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 capitalize whitespace-nowrap ${
                  activeTab === tab 
                    ? 'bg-white text-teal-900 shadow-sm' 
                    : 'text-teal-200 hover:bg-teal-700'
                }`}
              >
                {tab}
              </button>
            ))}
          </div>
        </div>
      </nav>

      {/* Main Content Area */}
      <main className="max-w-5xl mx-auto mt-8 px-4">
        
        {/* READING SECTION */}
        {activeTab === 'reading' && (
          <div className="animate-fade-in">
            <div className="grid md:grid-cols-2 gap-8 items-start">
              {/* Visual / Image Placeholder */}
              <div className="relative group rounded-xl overflow-hidden shadow-2xl h-96 bg-stone-200">
                {/* INSTRUCTIONS FOR USER:
                    To use your own image, replace the URL inside the src="" quotes below.
                    Example: src="https://i.imgur.com/your-image.jpg"
                */}
                <img 
                  src="image_7be5dc.jpg"
                  onError={(e) => {
                    e.target.onerror = null; 
                    e.target.src = "https://images.unsplash.com/photo-1534528741775-53994a69daeb?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80"; // Fallback if local file missing
                    e.target.alt = "Fallback image of storyteller (Local file not found)";
                  }}
                  alt="Clea Kalz in ceremonial button blanket standing before a totem screen" 
                  className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
                />
                
                <div className="absolute inset-0 bg-gradient-to-t from-stone-900/80 via-transparent to-transparent"></div>
                <div className="absolute bottom-0 left-0 right-0 p-6 text-white">
                  <h3 className="text-xl font-bold flex items-center">
                    <History className="w-5 h-5 mr-2 text-teal-300" />
                    The Storyteller
                  </h3>
                  <p className="text-teal-100 text-sm opacity-90 mt-1">Clea Kalz - Tlingit Tribe</p>
                </div>
              </div>

              {/* Text Content */}
              <div className="bg-white p-8 rounded-xl shadow-sm border border-stone-200">
                <div className="flex justify-between items-start mb-6">
                  <div>
                    <span className="text-teal-600 font-bold text-xs tracking-widest uppercase mb-1 block">Reading Section</span>
                    <h2 className="text-3xl font-serif font-bold text-stone-900">{storyTitle}</h2>
                  </div>
                  <button 
                    onClick={handleSpeak}
                    className={`p-3 rounded-full transition-colors ${speechSpeaking ? 'bg-red-100 text-red-600 animate-pulse' : 'bg-teal-50 text-teal-700 hover:bg-teal-100'}`}
                    title="Listen to the story"
                  >
                    {speechSpeaking ? <Volume2 size={24} /> : <Mic size={24} />}
                  </button>
                </div>

                <div className="prose prose-stone leading-relaxed text-lg font-serif">
                  <p>
                    <span className="text-4xl float-left mr-2 mt-[-10px] font-bold text-teal-800">"</span>
                    When I was a child," says Clea Kalz, "my grandma <span className="bg-yellow-100 px-1 rounded border-b-2 border-yellow-300 cursor-help" title="Repeated past action">used to tell</span> me traditional stories, about Raven and how he brought light to our world."
                  </p>
                  <p className="mt-4">
                    Clea is a member of the Tlingit tribe in North Alaska, and the oral stories her grandma told her preserve their culture and beliefs. Her grandmother remembered them because the Tlingit people had been telling the same stories for hundreds of years.
                  </p>
                  <p className="mt-4">
                    Storytelling predates writing. In early societies, people <span className="bg-yellow-100 px-1 rounded border-b-2 border-yellow-300 cursor-help" title="Repeated past action">would tell</span> stories orally, passing on information from one generation to the next. <span className="bg-orange-100 px-1 rounded border-b-2 border-orange-300 cursor-help" title="Past State">There used to be</span> stories to remember historical events, and there were stories that taught important life lessons, too.
                  </p>
                  <p className="mt-4">
                    Today we <span className="bg-green-100 px-1 rounded border-b-2 border-green-300 cursor-help" title="Normal situation now">are used to reading</span> written accounts of past events. It would be hard to <span className="bg-blue-100 px-1 rounded border-b-2 border-blue-300 cursor-help" title="Process of becoming normal">get used to memorizing</span> stories again.
                  </p>
                </div>
                
                <div className="mt-8 p-4 bg-teal-50 rounded-lg flex items-start space-x-3 text-sm text-teal-800">
                  <Info className="w-5 h-5 flex-shrink-0 mt-0.5" />
                  <p>Tip: Hover over the highlighted phrases to see a quick hint about the grammar usage!</p>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* GRAMMAR INFOGRAPHIC SECTION */}
        {activeTab === 'grammar' && (
          <div className="animate-fade-in space-y-8">
            <div className="text-center max-w-2xl mx-auto">
              <h2 className="text-3xl font-bold text-stone-900 mb-3">Grammar Technology</h2>
              <p className="text-stone-600">Visualizing "Past Habits" vs. "Changing States"</p>
            </div>

            {/* Video Embed Section */}
            <div className="w-full max-w-3xl mx-auto aspect-video bg-stone-900 rounded-xl overflow-hidden shadow-xl border-4 border-white">
              <iframe 
                src="https://drive.google.com/file/d/1ZxVpta3vAD_PtbA6gFBi4Pqm9BcY5aFc/preview" 
                className="w-full h-full" 
                allow="autoplay; fullscreen"
                title="Grammar Video Lesson"
              ></iframe>
            </div>

            <div className="grid md:grid-cols-2 gap-6">
              {/* Card 1: The Past */}
              <div className="bg-white rounded-2xl shadow-lg overflow-hidden border border-stone-200 flex flex-col h-full">
                <div className="bg-amber-500 p-4 text-white flex items-center space-x-3">
                  <History size={24} />
                  <h3 className="font-bold text-lg">The Past (No Longer True)</h3>
                </div>
                <div className="p-6 space-y-6 flex-grow">
                  
                  {/* Used To */}
                  <div className="relative pl-6 border-l-4 border-amber-200">
                    <h4 className="font-bold text-amber-700 flex items-center text-lg">
                      used to + infinitive
                    </h4>
                    <p className="text-sm text-stone-600 mb-2">For <strong>actions</strong> OR <strong>states</strong> in the past that don't happen now.</p>
                    <ul className="space-y-2 mt-3">
                      <li className="bg-stone-50 p-3 rounded text-sm italic text-stone-700 border-l-2 border-amber-300">
                        "My grandma <strong className="text-amber-600">used to tell</strong> me stories." <span className="text-xs text-stone-500 not-italic block mt-1">(Action)</span>
                      </li>
                      <li className="bg-stone-50 p-3 rounded text-sm italic text-stone-700 border-l-2 border-amber-300">
                         "I <strong className="text-amber-600">used to have</strong> short hair." <span className="text-xs text-stone-500 not-italic block mt-1">(State - Situation)</span>
                      </li>
                      <li className="bg-stone-50 p-3 rounded text-sm italic text-stone-700 border-l-2 border-amber-300">
                         "She <strong className="text-amber-600">used to love</strong> chocolate." <span className="text-xs text-stone-500 not-italic block mt-1">(State - Feeling)</span>
                      </li>
                    </ul>
                  </div>

                  {/* Would */}
                  <div className="relative pl-6 border-l-4 border-amber-200">
                    <h4 className="font-bold text-amber-700 flex items-center text-lg">
                      would + infinitive
                    </h4>
                    <p className="text-sm text-stone-600 mb-2">Strictly for repeated <span className="underline decoration-wavy decoration-amber-400 font-bold">actions</span> only.</p>
                     <ul className="space-y-2 mt-3">
                      <li className="bg-stone-50 p-3 rounded text-sm italic text-stone-700 border-l-2 border-amber-300">
                        "People <strong className="text-amber-600">would tell</strong> stories orally."
                      </li>
                       <li className="bg-stone-50 p-3 rounded text-sm italic text-stone-700 border-l-2 border-amber-300">
                        "Every summer, we <strong className="text-amber-600">would go</strong> camping."
                      </li>
                    </ul>
                  </div>

                   {/* ALERT BOX: STATE VERBS */}
                  <div className="bg-red-50 border border-red-200 rounded-lg p-4 mt-4">
                    <div className="flex items-center text-red-700 font-bold mb-2">
                      <AlertTriangle className="w-5 h-5 mr-2" />
                      CRITICAL RULE: State Verbs
                    </div>
                    <p className="text-sm text-red-800 mb-2">
                      Verbs that describe a state (be, have, love, know, understand) <strong>CANNOT</strong> use 'would'.
                    </p>
                    <div className="flex flex-col space-y-2 text-sm">
                      <div className="flex items-center text-green-700 bg-green-100 p-2 rounded">
                        <Check size={16} className="mr-2"/> "I <strong>used to be</strong> a student."
                      </div>
                      <div className="flex items-center text-red-700 bg-red-100 p-2 rounded opacity-75">
                        <X size={16} className="mr-2"/> <s>"I <strong>would be</strong> a student."</s>
                      </div>
                    </div>
                  </div>

                </div>
              </div>

              {/* Card 2: Habits & Familiarity */}
              <div className="bg-white rounded-2xl shadow-lg overflow-hidden border border-stone-200 flex flex-col h-full">
                <div className="bg-teal-600 p-4 text-white flex items-center space-x-3">
                  <RefreshCw size={24} />
                  <h3 className="font-bold text-lg">Habits & Familiarity</h3>
                </div>
                <div className="p-6 space-y-6 flex-grow">
                  
                  {/* Be Used To */}
                  <div className="relative pl-6 border-l-4 border-teal-200">
                    <h4 className="font-bold text-teal-700 flex items-center text-lg">
                      be used to + noun/-ing
                    </h4>
                    <p className="text-sm text-stone-600 mb-2">Something is normal/familiar for you <strong>now</strong>. It is not strange.</p>
                    <ul className="space-y-2 mt-3">
                      <li className="bg-stone-50 p-3 rounded text-sm italic text-stone-700 border-l-2 border-teal-300">
                        "We <strong className="text-teal-600">are used to reading</strong>."
                      </li>
                      <li className="bg-stone-50 p-3 rounded text-sm italic text-stone-700 border-l-2 border-teal-300">
                        "He <strong className="text-teal-600">is used to the cold</strong> weather."
                      </li>
                      <li className="bg-stone-50 p-3 rounded text-sm italic text-stone-700 border-l-2 border-teal-300">
                        "Are you <strong className="text-teal-600">used to driving</strong> on the left?"
                      </li>
                    </ul>
                    <div className="mt-2 flex items-center space-x-2 text-teal-700 text-xs font-medium">
                      <Check size={14} /> State: Current Comfort
                    </div>
                  </div>

                  {/* Get Used To */}
                  <div className="relative pl-6 border-l-4 border-teal-200">
                    <h4 className="font-bold text-teal-700 flex items-center text-lg">
                      get used to + noun/-ing
                    </h4>
                    <p className="text-sm text-stone-600 mb-2">The <strong>process</strong> of something becoming normal. It takes effort.</p>
                    <ul className="space-y-2 mt-3">
                      <li className="bg-stone-50 p-3 rounded text-sm italic text-stone-700 border-l-2 border-teal-300">
                        "It's hard to <strong className="text-teal-600">get used to memorizing</strong>."
                      </li>
                      <li className="bg-stone-50 p-3 rounded text-sm italic text-stone-700 border-l-2 border-teal-300">
                        "I am slowly <strong className="text-teal-600">getting used to</strong> my new glasses."
                      </li>
                      <li className="bg-stone-50 p-3 rounded text-sm italic text-stone-700 border-l-2 border-teal-300">
                        "She never <strong className="text-teal-600">got used to</strong> the noise."
                      </li>
                    </ul>
                    <div className="mt-2 flex items-center space-x-2 text-teal-700 text-xs font-medium">
                      <ArrowRight size={14} /> Action: The Change
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </div>
        )}

        {/* INTERACTIVE PRACTICE SECTION - REPLACED WITH BLOOKET LINK */}
        {activeTab === 'practice' && (
          <div className="max-w-2xl mx-auto animate-fade-in pb-12 text-center">
            <div className="mb-8">
              <h2 className="text-3xl font-bold text-stone-900">Practice Time!</h2>
              <p className="text-stone-500">Test your knowledge with our Blooket game.</p>
            </div>

            <div className="bg-white p-8 rounded-xl shadow-lg border-2 border-teal-100 flex flex-col items-center justify-center space-y-6 hover:border-teal-300 transition-all">
              
              {/* Blooket Logo */}
              <img 
                src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/78/Blooket_Logo.svg/1200px-Blooket_Logo.svg.png" 
                alt="Blooket Logo" 
                className="h-16 object-contain"
                onError={(e) => {
                    e.target.onerror = null; 
                    e.target.style.display = 'none'; // Hide image if it fails
                }}
              />
              {/* Fallback text if image fails/loads slowly, styled like Blooket */}
              <h3 className="text-4xl font-extrabold text-[#0bc2cf] tracking-tight hidden peer-checked:block">Blooket</h3>

              <p className="text-lg text-stone-700 text-center max-w-md">
                Join the game set: <strong>Used to vs. Would vs. Get/Be Used To</strong>
              </p>

              <a 
                href="https://dashboard.blooket.com/set/6921c34377d2500f1bd7ef71" 
                target="_blank" 
                rel="noopener noreferrer"
                className="flex items-center space-x-3 px-8 py-4 bg-[#0bc2cf] hover:bg-[#09a3ae] text-white font-bold text-xl rounded-xl shadow-md transition-transform hover:scale-105 active:scale-95"
              >
                <Gamepad2 className="w-8 h-8" />
                <span>Play Now</span>
              </a>
            </div>
          </div>
        )}

        {/* REWRITE PRACTICE SECTION */}
        {activeTab === 'rewrite' && (
          <RewriteSection />
        )}

      </main>
    </div>
  );
};

// NEW: Rewrite Section Component
const RewriteSection = () => {
  const [answers, setAnswers] = useState({});
  const [results, setResults] = useState({});

  const rewrites = [
    {
      id: 1,
      original: "It was my habit to ride my bike to school.",
      keyword: "USED TO",
      correct: "I used to ride my bike to school",
      hint: "Start with 'I'...",
      explanation: "We use 'used to' for past habits."
    },
    {
      id: 2,
      original: "Every Sunday, my grandfather visited us.",
      keyword: "WOULD",
      correct: "My grandfather would visit us every Sunday",
      alternates: ["Every Sunday my grandfather would visit us"],
      hint: "This is a repeated action in the past.",
      explanation: "'Would' emphasizes the repetition of the action."
    },
    {
      id: 3,
      original: "It is normal for me to wake up early.",
      keyword: "AM USED TO",
      correct: "I am used to waking up early",
      hint: "Don't forget the -ing form!",
      explanation: "After 'be used to', we use the verb + -ing."
    },
    {
      id: 4,
      original: "Driving on the left was strange at first, but now it's becoming normal.",
      keyword: "GETTING USED TO",
      correct: "I am getting used to driving on the left",
      hint: "This describes the process of change.",
      explanation: "'Get used to' shows the process of becoming accustomed to something."
    },
    {
      id: 5,
      original: "It was her habit to smoke 20 cigarettes a day.",
      keyword: "USED TO",
      correct: "She used to smoke 20 cigarettes a day",
      hint: "Start with 'She'...",
      explanation: "A past habit that is no longer true uses 'used to'."
    },
    {
      id: 6,
      original: "It is becoming normal for him to wear glasses.",
      keyword: "GETTING USED TO",
      correct: "He is getting used to wearing glasses",
      hint: "Use the -ing form after 'to'.",
      explanation: "The process of something becoming normal = get used to."
    },
    {
      id: 7,
      original: "It is normal for them to eat dinner late.",
      keyword: "ARE USED TO",
      correct: "They are used to eating dinner late",
      hint: "Don't forget the gerund (-ing).",
      explanation: "Current state of being accustomed = be used to."
    },
    {
      id: 8,
      original: "We went to the park every Saturday when I was young.",
      keyword: "WOULD",
      correct: "We would go to the park every Saturday",
      hint: "Repeated past action.",
      explanation: "For repeated actions in the past, 'would' is stylistically good."
    },
    {
      id: 9,
      original: "I didn't have a beard in the past (but now I do).",
      keyword: "USE TO",
      correct: "I didn't use to have a beard",
      hint: "Negative form: didn't use to...",
      explanation: "Note the spelling: didn't USE to (no 'd')."
    },
    {
      id: 10,
      original: "Is it normal for you to drive on the right?",
      keyword: "ARE YOU USED TO",
      correct: "Are you used to driving on the right",
      hint: "Question form + -ing.",
      explanation: "Asking about current familiarity."
    },
    {
      id: 11,
      original: "The noise was strange at first, but it's okay now.",
      keyword: "GOT USED TO",
      correct: "I got used to the noise",
      hint: "Past tense of get.",
      explanation: "The process happened in the past."
    },
    {
      id: 12,
      original: "He was a teacher (but isn't now).",
      keyword: "USED TO",
      correct: "He used to be a teacher",
      hint: "State verb 'be'.",
      explanation: "For past states, we must use 'used to', never 'would'."
    }
  ];

  const checkAnswer = (id) => {
    const userAns = answers[id]?.trim().toLowerCase().replace(/[.,!]/g, '') || "";
    const currentQ = rewrites.find(q => q.id === id);
    const correctAns = currentQ.correct.toLowerCase().replace(/[.,!]/g, '');
    const alternateAns = currentQ.alternates?.map(a => a.toLowerCase().replace(/[.,!]/g, ''));

    if (userAns === correctAns || (alternateAns && alternateAns.includes(userAns))) {
      setResults(prev => ({ ...prev, [id]: 'correct' }));
    } else {
      setResults(prev => ({ ...prev, [id]: 'incorrect' }));
    }
  };

  const reset = (id) => {
    setAnswers(prev => ({ ...prev, [id]: '' }));
    setResults(prev => {
      const newRes = { ...prev };
      delete newRes[id];
      return newRes;
    });
  };

  return (
    <div className="max-w-3xl mx-auto animate-fade-in pb-12">
      <div className="text-center mb-8">
        <h2 className="text-3xl font-bold text-stone-900">Rewrite Challenge</h2>
        <p className="text-stone-500">Type the sentence again using the grammar keyword.</p>
      </div>

      <div className="space-y-8">
        {rewrites.map((item) => (
          <div key={item.id} className="bg-white rounded-xl shadow-md border border-stone-200 overflow-hidden">
            <div className="bg-stone-100 p-4 border-b border-stone-200 flex justify-between items-center">
              <span className="font-bold text-stone-600">Question {item.id}</span>
              <div className="flex items-center text-xs font-bold text-teal-700 bg-teal-100 px-2 py-1 rounded uppercase tracking-wide">
                <Edit3 size={12} className="mr-1" /> Use: {item.keyword}
              </div>
            </div>
            
            <div className="p-6">
              <p className="text-lg text-stone-800 mb-4 font-serif italic">"{item.original}"</p>
              
              <div className="relative">
                <input 
                  type="text"
                  value={answers[item.id] || ''}
                  onChange={(e) => setAnswers({...answers, [item.id]: e.target.value})}
                  placeholder="Type your answer here..."
                  className={`w-full p-4 rounded-lg border-2 outline-none transition-all font-medium ${
                    results[item.id] === 'correct' 
                      ? 'border-green-500 bg-green-50 text-green-800' 
                      : results[item.id] === 'incorrect'
                        ? 'border-red-300 bg-red-50'
                        : 'border-stone-200 focus:border-teal-500'
                  }`}
                  disabled={results[item.id] === 'correct'}
                />
                
                {results[item.id] === 'correct' && (
                  <div className="absolute right-4 top-4 text-green-600 animate-bounce">
                    <Check size={24} />
                  </div>
                )}
              </div>

              {results[item.id] === 'incorrect' && (
                <div className="mt-4 animate-fade-in">
                  <div className="p-3 bg-red-50 text-red-800 rounded-lg text-sm mb-2 flex items-start">
                    <AlertTriangle size={16} className="mr-2 mt-0.5 flex-shrink-0" />
                    <div>
                      <strong>Not quite.</strong>
                      <p className="mt-1">Correct answer: <span className="font-mono bg-white px-1 rounded border border-red-200">{item.correct}</span></p>
                    </div>
                  </div>
                  <div className="flex items-center text-stone-500 text-xs">
                    <Info size={12} className="mr-1" /> {item.explanation}
                  </div>
                </div>
              )}

              {results[item.id] === 'correct' && (
                 <div className="mt-4 animate-fade-in p-3 bg-green-50 text-green-800 rounded-lg text-sm flex items-start">
                    <Star size={16} className="mr-2 mt-0.5 flex-shrink-0 text-yellow-500" />
                    <div>
                      <strong>Excellent!</strong> {item.explanation}
                    </div>
                 </div>
              )}

              <div className="mt-6 flex justify-end space-x-3">
                {results[item.id] ? (
                   <button 
                    onClick={() => reset(item.id)}
                    className="flex items-center px-4 py-2 text-stone-500 hover:text-stone-800 hover:bg-stone-100 rounded transition-colors"
                   >
                     <RotateCcw size={16} className="mr-2" /> Try Again
                   </button>
                ) : (
                  <button 
                    onClick={() => checkAnswer(item.id)}
                    className="px-6 py-2 bg-teal-600 hover:bg-teal-700 text-white font-bold rounded-lg shadow transition-transform active:scale-95"
                  >
                    Check Answer
                  </button>
                )}
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

export default StudyPage;
